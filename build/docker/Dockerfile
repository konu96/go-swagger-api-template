FROM golang:1.17 as builder

COPY go.* /src/
WORKDIR /src
RUN go mod download

ADD . /src
RUN CGO_ENABLED=0 go build -o main cmd/main.go

FROM alpine:latest

ARG API_TOKEN
ARG ACCESS_ID
ARG SECRET_KEY
ARG S3_URL
ARG CLOUDFRONT_URL
ARG DB_USER
ARG DB_PASSWORD
ARG DB_HOST
ARG DB_NAME
ARG DB_PORT

ENV API_TOKEN $API_TOKEN
ENV ACCESS_ID $ACCESS_ID
ENV SECRET_KEY $SECRET_KEY
ENV S3_URL $S3_URL
ENV CLOUDFRONT_URL $CLOUDFRONT_URL
ENV DB_USER $DB_USER
ENV DB_PASSWORD $DB_PASSWORD
ENV DB_HOST $DB_HOST
ENV DB_NAME $DB_NAME
ENV DB_PORT $DB_PORT

COPY --from=builder /src/main /main

EXPOSE 8080

CMD ["/main"]
